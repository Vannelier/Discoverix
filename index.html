<!doctype html>
<html lang='fr'>
<head>
  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1' />
  <title>Discoverix</title>

  <link rel='icon' href='./favicon.svg' type='image/svg+xml' />

  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.10);
      --border: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --muted2: rgba(255,255,255,0.55);
      --shadow: 0 18px 45px rgba(0,0,0,0.45);
      --radius: 18px;
      --focus: 0 0 0 3px rgba(90,170,255,0.25);
      --ok: #27c26a;
      --bad: #ff6b6b;
      --gold: rgba(255, 208, 90, 0.35);
      --gold2: rgba(255, 208, 90, 0.18);
    }

    *{ box-sizing: border-box; }
    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(70,130,255,0.24), transparent 55%),
        radial-gradient(900px 600px at 90% 25%, rgba(255,120,200,0.16), transparent 60%),
        radial-gradient(900px 700px at 50% 105%, rgba(50,220,160,0.10), transparent 50%),
        var(--bg);
      min-height: 100vh;
    }

    .wrap{ max-width: 920px; margin: 22px auto; padding: 0 14px 40px 14px; }

    .header{
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px; margin-bottom: 14px;
    }
    .title h1{ margin: 0; font-size: 34px; line-height: 1.1; }
    .title .sub{ margin: 2px 0 0 0; font-size: 13px; color: var(--muted); }

    .right{ display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }

    .pill{
      display: inline-flex; align-items: center; gap: 8px;
      border: 1px solid var(--border);
      background: var(--panel);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: 0 8px 22px rgba(0,0,0,0.25);
    }
    .dot{ width: 10px; height: 10px; border-radius: 999px; background: var(--muted2); }
    .dot.ok{ background: var(--ok); }
    .dot.bad{ background: var(--bad); }

    .btn{
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
    }
    .btn.primary{
      background: rgba(90,170,255,0.22);
      border-color: rgba(90,170,255,0.35);
    }
    .btn:focus{ outline: none; box-shadow: var(--focus); }
    .btn:disabled{ opacity: 0.55; cursor: not-allowed; }

    .error{
      display: none;
      border: 1px solid rgba(255,107,107,0.35);
      background: rgba(255,107,107,0.10);
      padding: 12px 14px;
      border-radius: 14px;
      margin: 10px 0;
      white-space: pre-wrap;
    }

    .grid{ display: grid; grid-template-columns: 1fr; gap: 14px; margin-top: 10px; }

    .card{
      border: 1px solid var(--border);
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2{
      margin: 0 0 10px 0;
      font-size: 14px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }

    .hintBox{ display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: start; }

    .hints{
      margin: 0; padding: 0; list-style: none;
      display: flex; flex-direction: column; gap: 6px;
    }
    .hints li{
      display: flex; gap: 8px; align-items: baseline;
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      background: rgba(0,0,0,0.14);
    }
    .hnum{
      width: 20px; color: rgba(255,255,255,0.55);
      font-variant-numeric: tabular-nums;
      font-weight: 800;
    }
    .htext{ color: rgba(255,255,255,0.92); font-weight: 650; }

    .hintMeta{
      display: flex; flex-wrap: wrap; gap: 10px; align-items: center;
      margin-top: 10px; color: var(--muted); font-size: 13px;
    }

    .stats{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: start;
      min-width: 240px;
    }
    .statBox{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
      border-radius: 14px;
      padding: 10px 10px;
      text-align: right;
    }
    .statLabel{ font-size: 12px; color: var(--muted2); margin-bottom: 6px; }
    .statValue{ font-size: 26px; font-weight: 900; letter-spacing: 0.2px; }
    .bar{ width: 100%; height: 10px; background: rgba(255,255,255,0.10); border-radius: 999px; overflow: hidden; border: 1px solid rgba(255,255,255,0.10); }
    .bar > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(90,170,255,0.8), rgba(50,220,160,0.8), rgba(255,200,80,0.85), rgba(255,105,180,0.7));
      transition: width 520ms ease;
    }

    .inputRow{ display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
    .input{
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 14px;
      font-size: 16px;
    }
    .input::placeholder{ color: rgba(255,255,255,0.45); }

    .listHeader{ display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-top: 8px; }
    .listHeader .meta{ color: var(--muted); font-size: 13px; }

    .list{
      margin-top: 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      background: rgba(0,0,0,0.12);
      max-height: 380px;
      overflow-y: auto;
    }
    .rowItem{
      display: grid;
      grid-template-columns: 54px 1fr 90px 96px;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      align-items: center;
      font-size: 14px;
    }
    .rowItem:last-child{ border-bottom: none; }
    .idx{ color: rgba(255,255,255,0.55); font-variant-numeric: tabular-nums; }
    .word{ overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: 650; }
    .badge{
      justify-self: end;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 68px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      font-weight: 900;
      font-variant-numeric: tabular-nums;
    }
    .heat{ justify-self: end; color: rgba(255,255,255,0.70); font-size: 12px; text-transform: uppercase; letter-spacing: 0.6px; }

    .rowItem.best{
      background: linear-gradient(90deg, var(--gold2), rgba(0,0,0,0.00));
      border-left: 3px solid rgba(255, 208, 90, 0.75);
    }
    .rowItem.best .badge{
      border-color: var(--gold);
      background: rgba(255, 208, 90, 0.10);
    }

    @keyframes popGlow {
      0% { transform: translateY(0); box-shadow: var(--shadow); }
      40% { transform: translateY(-2px); box-shadow: 0 26px 70px rgba(0,0,0,0.55); }
      100% { transform: translateY(0); box-shadow: var(--shadow); }
    }
    @keyframes hintFlash {
      0% { background: rgba(90,170,255,0.18); }
      100% { background: rgba(0,0,0,0.14); }
    }
    .hintPop { animation: popGlow 650ms ease; }
    .hints li.newHint { animation: hintFlash 900ms ease; }

    /* Modal base */
    .modal-backdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.58);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 100;
    }
    .modal{
      width: 100%;
      max-width: 560px;
      background: rgba(15,20,35,0.92);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 18px;
      padding: 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .modal h3{ margin: 0 0 6px 0; font-size: 18px; }
    .modal p{ margin: 0 0 12px 0; color: var(--muted); font-size: 13px; line-height: 1.35; }
    code{
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 2px 6px;
      border-radius: 8px;
      color: rgba(255,255,255,0.9);
    }

    /* Victory overlay (juicy) */
    .win-backdrop{
      position: fixed; inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 200;
      background:
        radial-gradient(900px 600px at 30% 20%, rgba(255,200,80,0.20), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(90,170,255,0.18), transparent 60%),
        rgba(0,0,0,0.62);
      backdrop-filter: blur(6px);
    }
    .win-card{
      width: 100%;
      max-width: 680px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(18,22,38,0.92);
      box-shadow: 0 30px 100px rgba(0,0,0,0.65);
      padding: 16px;
      position: relative;
      overflow: hidden;
      transform: translateY(6px) scale(0.98);
      opacity: 0;
      animation: winIn 520ms cubic-bezier(.2,1.1,.2,1) forwards;
    }
    @keyframes winIn{
      to { transform: translateY(0) scale(1); opacity: 1; }
    }
    .win-card::before{
      content: '';
      position: absolute; inset: -2px;
      background: linear-gradient(120deg, rgba(255,200,80,0.14), rgba(90,170,255,0.12), rgba(50,220,160,0.10));
      filter: blur(18px);
      opacity: 0.75;
      pointer-events: none;
    }
    .win-top{
      position: relative;
      display: flex;
      align-items: start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .win-title{
      font-size: 22px;
      margin: 0;
      letter-spacing: 0.2px;
    }
    .win-sub{
      margin: 6px 0 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    .win-burst{
      position: absolute;
      right: -110px; top: -110px;
      width: 260px; height: 260px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,208,90,0.25), transparent 65%);
      filter: blur(2px);
      animation: burstSpin 2.6s linear infinite;
      opacity: 0.9;
      pointer-events: none;
    }
    @keyframes burstSpin{
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .win-actions{
      position: relative;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 12px;
    }

    .win-list{
      position: relative;
      margin: 10px 0 0 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .win-li{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      border-radius: 14px;
      padding: 12px;
    }

    .win-li .k{
      font-size: 12px;
      color: var(--muted2);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      font-weight: 900;
      margin-bottom: 6px;
    }

    .win-li .v{
      font-size: 15px;
      font-weight: 850;
      line-height: 1.35;
      color: rgba(255,255,255,0.92);
      white-space: pre-wrap;
    }

    .confetti{
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 999;
      display: none;
    }

    @media (max-width: 720px){
      .title h1{ font-size: 28px; }
      .rowItem{ grid-template-columns: 44px 1fr 80px 80px; }
      .stats{ grid-template-columns: 1fr; min-width: 180px; }
    }
  </style>
</head>

<body>
  <div class='wrap'>
    <div class='header'>
      <div class='title'>
        <h1>Discoverix</h1>
        <div class='sub'>Devine l'oeuvre ou la decouverte: un nouveau puzzle chaque jour, et a toi de faire chauffer les neurones.</div>
      </div>

      <div class='right'>
        <div class='pill' title='Etat de connexion a l API'>
          <span class='dot' id='apiDot'></span>
          <span id='apiState'>API: inconnue</span>
        </div>

        <div class='pill'>
          <span id='puzzleTag'>Puzzle: (aucun)</span>
        </div>

        <div class='pill'>
          <span id='nextPuzzle'>Prochain puzzle a 00:00 (dans 00:00:00)</span>
        </div>

        <button class='btn' id='changePuzzleBtn' type='button'>Choisir puzzle</button>
      </div>
    </div>

    <div class='error' id='errorBox'></div>

    <div class='grid'>
      <div class='card' id='hintCard'>
        <h2>Indices</h2>

        <div class='hintBox'>
          <div>
            <ul class='hints' id='hintsList'></ul>

            <div class='hintMeta'>
              <span>Essais uniques: <b id='guessCount'>0</b></span>
              <span style='opacity:0.45;'>|</span>
              <span id='nextHint'>Prochain indice: -</span>
            </div>
          </div>

          <div class='stats'>
            <div class='statBox'>
              <div class='statLabel'>Dernier score</div>
              <div class='statValue' id='lastScore'>--</div>
              <div class='bar'><div id='lastBar'></div></div>
            </div>
            <div class='statBox'>
              <div class='statLabel'>Meilleur score</div>
              <div class='statValue' id='bestScore'>--</div>
              <div class='bar'><div id='bestBar'></div></div>
            </div>
          </div>
        </div>
      </div>

      <div class='card'>
        <h2>Proposition</h2>
        <div class='inputRow'>
          <input class='input' id='guessInput' placeholder='Tape un mot ou une expression' disabled />
          <button class='btn primary' id='guessBtn' disabled>Valider</button>
        </div>

        <div class='listHeader'>
          <div class='meta' id='listMeta'>Aucune proposition.</div>
          <div class='meta'>Tri: meilleur score en haut</div>
        </div>

        <div class='list' id='list'></div>
      </div>
    </div>
  </div>

  <!-- Start modal -->
  <div class='modal-backdrop' id='modalBackdrop'>
    <div class='modal'>
      <h3>Demarrer une partie</h3>
      <p>Entre un <b>puzzle_id</b> existant dans ton CSV (ex: <code>1</code> ou <code>0001</code>). Ton API doit tourner sur <code>http://127.0.0.1:8000</code>.</p>
      <div class='inputRow'>
        <input class='input' id='puzzleInput' placeholder='puzzle_id (ex: 1)' />
        <button class='btn primary' id='startBtn' type='button'>Demarrer</button>
      </div>
    </div>
  </div>

  <!-- Victory overlay -->
  <div class='win-backdrop' id='winBackdrop'>
    <div class='win-card' id='winCard'>
      <div class='win-burst'></div>

      <div class='win-top'>
        <div>
          <h3 class='win-title' id='winTitle'>Victoire</h3>
          <p class='win-sub' id='winSub'></p>
        </div>
        <button class='btn' id='winCloseBtn' type='button'>Fermer</button>
      </div>

      <ul class='win-list' id='winList'></ul>

      <div class='win-actions'>
        <button class='btn primary' id='winNewBtn' type='button'>Nouveau puzzle</button>
      </div>
    </div>
  </div>

  <!-- Confetti canvas -->
  <canvas class='confetti' id='confettiCanvas'></canvas>

  <script>
    const API = 'http://127.0.0.1:8000/api/v1';

    let sessionId = null;
    let currentPuzzleId = null;
    let puzzleDay = null;

    let guessesLocal = [];
    let lastHintsCount = 0;

    const LS_KEY = 'discoverix_state_v1';

    function saveState() {
      try {
        localStorage.setItem(LS_KEY, JSON.stringify({ sessionId, currentPuzzleId, puzzleDay }));
      } catch {}
    }
    function loadState() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch { return null; }
    }
    function clearState() {
      try { localStorage.removeItem(LS_KEY); } catch {}
    }

    function showError(msg) {
      const box = document.getElementById('errorBox');
      box.style.display = 'block';
      box.textContent = msg;
    }
    function clearError() {
      const box = document.getElementById('errorBox');
      box.style.display = 'none';
      box.textContent = '';
    }

    function setGameEnabled(enabled) {
      document.getElementById('guessInput').disabled = !enabled;
      document.getElementById('guessBtn').disabled = !enabled;
      if (enabled) document.getElementById('guessInput').focus();
    }

    function scoreBand(score) {
      if (score >= 95) return 'incendie';
      if (score >= 90) return 'brulant';
      if (score >= 80) return 'tres chaud';
      if (score >= 70) return 'chaud';
      if (score >= 50) return 'tiede';
      if (score >= 5) return 'froid';
      return 'glacial';
    }

    function setApiState(ok) {
      const dot = document.getElementById('apiDot');
      const t = document.getElementById('apiState');
      dot.classList.remove('ok', 'bad');
      if (ok) { dot.classList.add('ok'); t.textContent = 'API: ok'; }
      else { dot.classList.add('bad'); t.textContent = 'API: indisponible'; }
    }

    function setBar(elId, value) {
      const el = document.getElementById(elId);
      const w = Math.max(0, Math.min(100, Number(value || 0)));
      el.style.width = w + '%';
    }
    function setBarAnimated(elId, value) {
      const el = document.getElementById(elId);
      const w = Math.max(0, Math.min(100, Number(value || 0)));
      requestAnimationFrame(() => { el.style.width = w + '%'; });
    }

    function setScoresUI(lastScore, bestScore) {
      const ls = document.getElementById('lastScore');
      const bs = document.getElementById('bestScore');

      ls.textContent = (lastScore === null || lastScore === undefined) ? '--' : String(lastScore);
      bs.textContent = (bestScore === null || bestScore === undefined) ? '--' : String(bestScore);

      setBarAnimated('lastBar', lastScore || 0);
      setBar('bestBar', bestScore || 0);
    }

    function escapeHtml(s) {
      return String(s || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function capitalizeFirst(s) {
      const t = String(s || '').trim();
      if (!t) return '';
      return t.charAt(0).toUpperCase() + t.slice(1);
    }

    function renderHints(hints) {
      const list = document.getElementById('hintsList');
      list.innerHTML = '';

      if (!hints || hints.length === 0) {
        const li = document.createElement('li');
        li.innerHTML = `<span class='hnum'>-</span><span class='htext'>(aucun indice)</span>`;
        list.appendChild(li);
        lastHintsCount = 0;
        return;
      }

      const isNewHint = hints.length > lastHintsCount;
      const newIndex = hints.length - 1;

      hints.forEach((h, i) => {
        const li = document.createElement('li');
        if (isNewHint && i === newIndex) li.classList.add('newHint');

        const num = (h && (h.label !== undefined && h.label !== null))
          ? String(h.label)
          : (h && h.step !== undefined && h.step !== null)
            ? String(Number(h.step) + 1)
            : String(i + 1);

        li.innerHTML = `<span class='hnum'>${escapeHtml(num)}</span><span class='htext'>${escapeHtml(h.text)}</span>`;
        list.appendChild(li);
      });

      if (isNewHint) {
        const card = document.getElementById('hintCard');
        card.classList.remove('hintPop');
        void card.offsetWidth;
        card.classList.add('hintPop');
      }

      lastHintsCount = hints.length;
    }

    function setMetaUI(guessCount, nextHintIn) {
      document.getElementById('guessCount').textContent = String(guessCount || 0);
      if (nextHintIn === null || nextHintIn === undefined) {
        document.getElementById('nextHint').textContent = 'Prochain indice: plus d\'indices';
      } else {
        document.getElementById('nextHint').textContent = `Prochain indice dans ${nextHintIn} essais`;
      }
    }

    function renderList(guesses) {
      const el = document.getElementById('list');
      const meta = document.getElementById('listMeta');

      if (!guesses || guesses.length === 0) {
        meta.textContent = 'Aucune proposition.';
        el.innerHTML = '';
        setScoresUI(null, null);
        return;
      }

      const sorted = guesses.slice().sort((a,b) => (b.score ?? 0) - (a.score ?? 0));
      const best = sorted[0].score ?? 0;

      const last = guesses[guesses.length - 1];
      const lastScore = last ? (last.score ?? 0) : null;

      setScoresUI(lastScore, best);
      meta.textContent = `${guesses.length} propositions (triees par score)`;

      el.innerHTML = sorted.map((g, idx) => {
        const rawWord = (g.normalized || g.raw || '');
        const displayWord = capitalizeFirst(rawWord);
        const sc = Number(g.score ?? 0);
        const heat = scoreBand(sc);
        const isBest = idx === 0;

        return `
          <div class='rowItem ${isBest ? 'best' : ''}'>
            <div class='idx'>#${idx+1}</div>
            <div class='word' title='${escapeHtml(displayWord)}'>${escapeHtml(displayWord)}</div>
            <div class='badge'>${sc}</div>
            <div class='heat'>${heat}</div>
          </div>
        `;
      }).join('');
    }

    function openModal() {
      document.getElementById('modalBackdrop').style.display = 'flex';
      document.getElementById('puzzleInput').value = currentPuzzleId || '';
      setTimeout(() => document.getElementById('puzzleInput').focus(), 30);
    }
    function closeModal() {
      document.getElementById('modalBackdrop').style.display = 'none';
    }

    function openWin() {
      document.getElementById('winBackdrop').style.display = 'flex';
      startConfetti(2200);
    }
    function closeWin() {
      document.getElementById('winBackdrop').style.display = 'none';
      stopConfetti();
    }

    async function pingApi() {
      try {
        const r = await fetch(`${API}/health`, { method: 'GET' });
        setApiState(r.ok);
      } catch {
        setApiState(false);
      }
    }

    function resetUiForNewGame(puzzleId) {
      clearError();
      sessionId = null;
      puzzleDay = null;
      currentPuzzleId = puzzleId;
      guessesLocal = [];
      lastHintsCount = 0;

      document.getElementById('puzzleTag').textContent = `Puzzle: ${puzzleId}`;
      renderHints([]);
      setMetaUI(0, null);
      renderList([]);
      setGameEnabled(false);
      saveState();
    }

    function mapGameplayError(err) {
      const e = String(err || 'erreur');
      if (e === 'not_in_dictionary') return 'Ce mot n\'existe pas dans le dictionnaire.';
      if (e === 'empty') return 'Saisie vide.';
      return `Erreur: ${e}`;
    }

    function formatHMS(ms) {
      const s = Math.max(0, Math.floor(ms / 1000));
      const hh = String(Math.floor(s / 3600)).padStart(2, '0');
      const mm = String(Math.floor((s % 3600) / 60)).padStart(2, '0');
      const ss = String(s % 60).padStart(2, '0');
      return `${hh}:${mm}:${ss}`;
    }

    function updateNextPuzzleCountdown() {
      const now = new Date();
      const next = new Date(now);
      next.setHours(24, 0, 0, 0);
      const ms = next.getTime() - now.getTime();
      const label = `Prochain puzzle a minuit (dans ${formatHMS(ms)})`;
      document.getElementById('nextPuzzle').textContent = label;
    }

    async function fetchWikiSummaryFromWikidata(qid) {
      if (!qid) return null;

      try {
        const entityUrl = `https://www.wikidata.org/wiki/Special:EntityData/${encodeURIComponent(qid)}.json`;
        const er = await fetch(entityUrl, { method: 'GET' });
        if (!er.ok) return null;

        const ej = await er.json();
        const ent = (ej && ej.entities && ej.entities[qid]) ? ej.entities[qid] : null;
        if (!ent) return null;

        const sitelinks = ent.sitelinks || {};
        const fr = sitelinks.frwiki ? sitelinks.frwiki.title : null;
        const en = sitelinks.enwiki ? sitelinks.enwiki.title : null;

        const lang = fr ? 'fr' : (en ? 'en' : null);
        const title = fr || en;
        if (!lang || !title) return null;

        const sumUrl = `https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
        const sr = await fetch(sumUrl, { method: 'GET' });
        if (!sr.ok) return null;

        const sj = await sr.json();
        if (!sj || !sj.extract) return null;

        const extract = String(sj.extract).trim();
        const pageUrl = sj.content_urls && sj.content_urls.desktop && sj.content_urls.desktop.page
          ? String(sj.content_urls.desktop.page)
          : `https://${lang}.wikipedia.org/wiki/${encodeURIComponent(title)}`;

        return { extract, pageUrl };
      } catch {
        return null;
      }
    }

    function renderWinReveal(winReveal, attempts) {
      const work = winReveal && winReveal.work_canonical ? winReveal.work_canonical : '--';
      const person = winReveal && winReveal.character_name_full ? winReveal.character_name_full : '--';
      const hints = winReveal && Array.isArray(winReveal.revealed_hints) ? winReveal.revealed_hints : [];
      const qid = winReveal && winReveal.wikidata_qid ? winReveal.wikidata_qid : '';

      const list = document.getElementById('winList');
      list.innerHTML = '';

      function addItem(key, value) {
        const li = document.createElement('li');
        li.className = 'win-li';
        li.innerHTML = `<div class='k'>${escapeHtml(key)}</div><div class='v'>${escapeHtml(value)}</div>`;
        list.appendChild(li);
      }

      function addItemHtml(key, htmlValue) {
        const li = document.createElement('li');
        li.className = 'win-li';
        li.innerHTML = `<div class='k'>${escapeHtml(key)}</div><div class='v'>${htmlValue}</div>`;
        list.appendChild(li);
      }

      addItem('Essais necessaires', String(attempts || 0));
      addItem('Oeuvre canonique', work);
      addItem('Inventeur', person);

      const byStep = new Map();
      hints.forEach(h => {
        if (h && h.step !== undefined && h.step !== null) byStep.set(Number(h.step), String(h.text || '').trim());
      });

      const allLines = [];
      for (let i = 0; i < 6; i++) {
        const t = byStep.has(i) ? byStep.get(i) : '';
        allLines.push(`- ${t ? t : '(indice non devoile)'}`);
      }
      addItem('Indices', allLines.join('\n'));

      const placeholder = `<span>Chargement...</span>`;
      addItemHtml('En deux mots', placeholder);

      fetchWikiSummaryFromWikidata(qid).then(obj => {
        const v = document.querySelector('#winList .win-li:last-child .v');
        if (!v) return;
        if (!obj || !obj.extract) {
          v.textContent = 'Pas de resume Wikipedia disponible.';
          return;
        }

        const short = obj.extract.length > 320 ? (obj.extract.slice(0, 320) + '...') : obj.extract;
        const safeShort = escapeHtml(short);
        const safeUrl = escapeHtml(obj.pageUrl || '');
        const link = obj.pageUrl
          ? `<div style='margin-top:10px;'><a href='${safeUrl}' target='_blank' rel='noopener noreferrer' style='color:rgba(90,170,255,0.95); font-weight:800; text-decoration:none;'>Voir plus</a></div>`
          : '';

        v.innerHTML = `${safeShort}${link}`;
      });
    }

    async function start(puzzleId) {
      puzzleId = (puzzleId || '').trim();
      if (!puzzleId) { showError('puzzle_id manquant.'); return; }

      resetUiForNewGame(puzzleId);

      try {
        const r = await fetch(`${API}/start`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ puzzle_id: puzzleId })
        });

        if (!r.ok) {
          const t = await r.text();
          showError(`Erreur start (${r.status}): ${t}`);
          setApiState(false);
          return;
        }

        const data = await r.json();
        sessionId = data.session_id;
        puzzleDay = data.puzzle_day || null;

        renderHints(data.revealed_hints);
        setMetaUI(data.guess_count_unique, data.next_hint_in);
        setGameEnabled(true);
        setApiState(true);
        closeModal();

        saveState();
      } catch {
        showError('Impossible de joindre l\'API. Verifie que uvicorn tourne sur 127.0.0.1:8000.');
        setApiState(false);
      }
    }

    async function tryResume() {
      const st = loadState();
      if (!st || !st.sessionId || !st.currentPuzzleId) return false;

      sessionId = st.sessionId;
      currentPuzzleId = st.currentPuzzleId;
      puzzleDay = st.puzzleDay || null;

      document.getElementById('puzzleTag').textContent = `Puzzle: ${currentPuzzleId}`;
      setGameEnabled(false);

      try {
        const s = await fetch(`${API}/session/${sessionId}`);
        if (!s.ok) {
          clearState();
          sessionId = null;
          puzzleDay = null;
          guessesLocal = [];
          return false;
        }

        const sess = await s.json();

        guessesLocal = Array.isArray(sess.guesses) ? sess.guesses : [];
        renderList(guessesLocal);
        renderHints(sess.revealed_hints || []);
        setMetaUI(sess.guess_count_unique || 0, sess.next_hint_in);

        setGameEnabled(!sess.is_win);
        setApiState(true);

        if (sess.is_win && sess.win_reveal) {
          document.getElementById('winTitle').textContent = 'Victoire';
          document.getElementById('winSub').textContent = '';
          renderWinReveal(sess.win_reveal, sess.guess_count_unique);
          openWin();
        }

        return true;
      } catch {
        clearState();
        return false;
      }
    }

    async function sendGuess() {
      clearError();
      const input = document.getElementById('guessInput');
      const guess = input.value.trim();
      if (!guess || !sessionId) return;

      setGameEnabled(false);

      try {
        const r = await fetch(`${API}/guess`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ session_id: sessionId, guess_text: guess })
        });

        if (!r.ok) {
          const t = await r.text();
          showError(`Erreur guess (${r.status}): ${t}`);
          input.select();
          return;
        }

        const data = await r.json();

        if (!data.ok) {
          renderHints(data.revealed_hints || []);
          setMetaUI(data.guess_count_unique || 0, data.next_hint_in);
          showError(mapGameplayError(data.error));
          input.select();
          return;
        }

        if (data.is_duplicate) {
          renderHints(data.revealed_hints || []);
          setMetaUI(data.guess_count_unique || 0, data.next_hint_in);
          showError('Deja propose.');
          input.select();
          return;
        }

        guessesLocal.push({
          raw: guess,
          normalized: data.normalized || guess,
          score: Number(data.score ?? 0)
        });

        renderHints(data.revealed_hints || []);
        setMetaUI(data.guess_count_unique || guessesLocal.length, data.next_hint_in);
        renderList(guessesLocal);

        input.value = '';
        input.focus();

        saveState();
        setApiState(true);

        if (data.is_win) {
          document.getElementById('winTitle').textContent = 'Victoire';
          document.getElementById('winSub').textContent = '';
          renderWinReveal(data.win_reveal || null, data.guess_count_unique);
          openWin();
          setGameEnabled(false);
        }
      } catch {
        showError('Erreur reseau pendant la proposition.');
        setApiState(false);
      } finally {
        if (document.getElementById('winBackdrop').style.display !== 'flex') {
          setGameEnabled(true);
        }
      }
    }

    // --- Confetti ---
    let _confettiRunning = false;
    let _confettiRAF = 0;
    let _confettiStopAt = 0;

    function startConfetti(durationMs) {
      const canvas = document.getElementById('confettiCanvas');
      const ctx = canvas.getContext('2d');

      function resize() {
        canvas.width = Math.floor(window.innerWidth * devicePixelRatio);
        canvas.height = Math.floor(window.innerHeight * devicePixelRatio);
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';
        ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
      }

      resize();
      window.addEventListener('resize', resize, { passive: true });

      canvas.style.display = 'block';
      _confettiRunning = true;
      _confettiStopAt = performance.now() + Math.max(400, Number(durationMs || 1800));

      const W = () => window.innerWidth;
      const H = () => window.innerHeight;

      const colors = [
        'rgba(255,200,80,0.95)',
        'rgba(90,170,255,0.95)',
        'rgba(50,220,160,0.95)',
        'rgba(255,105,180,0.95)',
        'rgba(255,255,255,0.90)'
      ];

      const parts = [];
      const count = Math.min(220, Math.max(120, Math.floor((W() * H()) / 9000)));

      for (let i = 0; i < count; i++) {
        parts.push({
          x: Math.random() * W(),
          y: -20 - Math.random() * H() * 0.4,
          vx: -1.6 + Math.random() * 3.2,
          vy: 2.8 + Math.random() * 5.2,
          g: 0.045 + Math.random() * 0.06,
          w: 6 + Math.random() * 10,
          h: 6 + Math.random() * 12,
          rot: Math.random() * Math.PI * 2,
          vr: -0.18 + Math.random() * 0.36,
          c: colors[(Math.random() * colors.length) | 0],
          a: 1.0
        });
      }

      function step(ts) {
        if (!_confettiRunning) return;

        ctx.clearRect(0, 0, W(), H());

        const fade = Math.max(0, Math.min(1, (_confettiStopAt - ts) / 500));

        for (const p of parts) {
          p.vy += p.g;
          p.x += p.vx;
          p.y += p.vy;
          p.rot += p.vr;

          if (p.x < -30) p.x = W() + 30;
          if (p.x > W() + 30) p.x = -30;

          if (p.y > H() + 40) {
            p.y = -30;
            p.x = Math.random() * W();
            p.vy = 2.8 + Math.random() * 5.2;
          }

          p.a = fade;

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);

          let fill = p.c;
          if (fill.includes('0.95')) fill = fill.replace('0.95', String(0.95 * p.a));
          if (fill.includes('0.90')) fill = fill.replace('0.90', String(0.90 * p.a));

          ctx.fillStyle = fill;
          ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
          ctx.restore();
        }

        if (ts >= _confettiStopAt) {
          stopConfetti();
          return;
        }

        _confettiRAF = requestAnimationFrame(step);
      }

      cancelAnimationFrame(_confettiRAF);
      _confettiRAF = requestAnimationFrame(step);
    }

    function stopConfetti() {
      _confettiRunning = false;
      cancelAnimationFrame(_confettiRAF);
      const canvas = document.getElementById('confettiCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      canvas.style.display = 'none';
    }

    // --- Events ---
    document.getElementById('guessBtn').addEventListener('click', sendGuess);
    document.getElementById('guessInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendGuess();
    });

    document.getElementById('changePuzzleBtn').addEventListener('click', openModal);
    document.getElementById('startBtn').addEventListener('click', () => {
      start(document.getElementById('puzzleInput').value);
    });
    document.getElementById('puzzleInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') start(document.getElementById('puzzleInput').value);
    });

    document.getElementById('winCloseBtn').addEventListener('click', () => {
      closeWin();
    });
    document.getElementById('winNewBtn').addEventListener('click', () => {
      closeWin();
      openModal();
    });

    (async () => {
      updateNextPuzzleCountdown();
      setInterval(updateNextPuzzleCountdown, 250);

      await pingApi();

      const resumed = await tryResume();
      if (!resumed) openModal();
   FPRave })();
  </script>
</body>
</html>
